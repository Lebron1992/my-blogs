åè®® (Protocol) æ˜¯ Swift è¯­è¨€ä¸­éå¸¸å¼ºå¤§è€Œçµæ´»çš„ä¸€ä¸ªç‰¹æ€§ã€‚è€Œå…¶ä¸­çš„å…³è”ç±»å‹å°±æ˜¯ Swift åè®®çµæ´»çš„ä¸€ä¸ªè¡¨ç°ã€‚

## å…³è”ç±»å‹

```swift
@available(OSX 10.15, iOS 13, tvOS 13, watchOS 6, *)
public protocol Identifiable {

    associatedtype ID: Hashable

    var id: Self.ID { get }
}
```

æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ iOS 13 æ–°å¢çš„ `Identifiable`ï¼Œå®ƒå£°æ˜äº†ä¸€ä¸ªéµå¾ª `Hashable` çš„å…³è”ç±»å‹ `ID`ï¼Œå¹¶ä¸”æŠŠå˜é‡ `id` å£°æ˜ä¸º `ID` ç±»å‹ã€‚è¿™ä¹ˆåšçš„å¥½å¤„æ˜¯å®ç° `Identifiable` åè®®çš„ç±»å‹ï¼Œå®ƒçš„ `id` å˜é‡å¯ä»¥æ˜¯ä»»ä½•éµå¾ª `Hashable` åè®®çš„ç±»å‹ã€‚ä¾‹å¦‚ï¼š

```swift
struct MyIdType: Hashable {
    let id: String
}

struct A: Identifiable {
    let id: String
}

struct B: Identifiable {
    let id: Int
}

struct C: Identifiable {
    let id: MyIdType
}
```

`A` ã€ `B` å’Œ `C` éƒ½å®ç°äº† `Identifiable` åè®®ï¼Œå…¶ä¸­ `C` çš„ `id` ç±»å‹æ˜¯è‡ªå®šä¹‰çš„éµå¾ª `Hashable` åè®®çš„ç±»å‹ã€‚

å…¶å®ï¼Œä¸Šé¢çš„ä»£ç æ˜¯ä¸€ä¸ªç®€å†™çš„å½¢å¼ï¼Œå¦‚æœæŠŠä»£ç å†™å…¨ï¼Œåº”è¯¥æ˜ç¡®æŒ‡å®š `ID` çš„ç±»å‹ï¼š

```swift
struct A: Identifiable {
    typealias ID = String
    let id: String
}

struct B: Identifiable {
    typealias ID = Int
    let id: Int
}

struct C: Identifiable {
    typealias ID = MyIdType
    let id: MyIdType
}
```

è¿™å°±æ˜¯ Swift åè®®çš„å…³è”ç±»å‹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠæœ‰å…³è”ç±»å‹çš„åè®®çœ‹åšæ˜¯**æ³›å‹åè®®**ã€‚å› ä¸ºæˆ‘ä»¬ä¼ ä»€ä¹ˆç±»å‹ç»™å…³è”ç±»å‹ï¼Œä»–å°±æ˜¯ä»€ä¹ˆç±»å‹ï¼Œä¸æ³›å‹ä¸€è‡´ã€‚

## çº¦æŸ

å…³è”ç±»å‹éå¸¸çµæ´»ï¼Œä½†æœ‰æ—¶å€™ä¸æƒ³è®©å®ƒè¿™ä¹ˆçµæ´»ï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨çº¦æŸæ¥é™åˆ¶å®ƒã€‚

å‡è®¾æœ‰ä¸€ä¸ª Apple Storeï¼Œé‡Œé¢å”®å– iPhoneã€Mac å’Œ Apple Watchã€‚æˆ‘ä»¬**è¦æ±‚é‡Œé¢çš„äº§å“å…·æœ‰ç›¸åŒçš„ logo**ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç”¨ä»£ç ä¸€æ­¥ä¸€æ­¥æ¼”ç¤ºã€‚

é¦–å…ˆå®šä¹‰ä¸€ä¸ª `AppleProduct`ï¼Œæè¿° Apple äº§å“ï¼Œä»£ç å¦‚ä¸‹ï¼š

```swift
protocol AppleProduct {
    associatedtype LogoType
    var logo: LogoType { get }
}
```

è¦æ±‚æ¯ä¸ªäº§å“æœ‰ä¸€ä¸ª `logo` å±æ€§ã€‚

æ¥ä¸‹æ¥ï¼Œå®šä¹‰ `AppleStore`ï¼Œæè¿° Apple Storeï¼Œå…ˆæŠŠå®ƒå†™æˆï¼š

```swift
protocol AppleStore {
    associatedtype IphoneType: AppleProduct
    associatedtype MacType: AppleProduct
    associatedtype WatchType: AppleProduct
    
    var iphones: [IphoneType] { get }
    var macs: [MacType] { get }
    var watches: [WatchType] { get }
}
```

ä»ä¸Šé¢çš„ä»£ç ä¸Šçœ‹ï¼Œæ‰€æœ‰çš„äº§å“éƒ½æ˜¯ `AppleProduct` ç±»å‹ï¼Œè¿™ä¸ªæ²¡é”™ï¼Œä½†æ˜¯æ¯ä¸€ç±»äº§å“çš„ logo å¯ä»¥æ˜¯ä¸åŒçš„ã€‚ä¾‹å¦‚ `IphoneType` çš„ logo å¯ä»¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸² `Apple`ï¼Œ`MacType` çš„ logo å¯ä»¥æ˜¯ä¸€ä¸ªè¢«å’¬äº†ä¸€å£çš„è‹¹æœå›¾åƒã€‚

é‚£å¦‚ä½•ä¿è¯æ‰€æœ‰äº§å“çš„ logo æ˜¯ç›¸åŒçš„ï¼Ÿè¿™æ—¶æˆ‘ä»¬å°±å¿…é¡»ç”¨åˆ°çº¦æŸï¼Œä½¿ç”¨ `where` å…³é”®å­—ã€‚æŠŠä»£ç æ”¹é€ å¦‚ä¸‹ï¼š

```swift
protocol AppleStore {
    associatedtype IphoneType: AppleProduct

    // é™åˆ¶ MacType çš„ LogoType ç­‰äº IphoneType çš„ LogoType
    associatedtype MacType: AppleProduct where MacType.LogoType == IphoneType.LogoType

    // é™åˆ¶ WatchType çš„ LogoType ç­‰äº IphoneType çš„ LogoType
    associatedtype WatchType: AppleProduct where WatchType.LogoType == IphoneType.LogoType
    
    var iphones: [IphoneType] { get }
    var macs: [MacType] { get }
    var watches: [WatchType] { get }
}
```

é€šè¿‡è¿™ä¸¤ä¸ªé™åˆ¶ï¼Œ`AppleStore` çš„ä¸‰ç§äº§å“çš„ logo éƒ½æ˜¯ç›¸åŒçš„äº†ã€‚

ä¸‹é¢æ˜¯ AppleStore çš„å…·ä½“å®ç°ï¼š

```swift
struct Iphone: AppleProduct {
    let logo: String
}

struct Mac: AppleProduct {
    let logo: String
}

struct Watch: AppleProduct {
    let logo: String
}

struct Store: AppleStore {
    var iphones: [Iphone] = []
    var macs: [Mac] = []
    var watches: [Watch] = []
}
```

å¦‚æœæŠŠ `Iphone` ã€ `Mac` å’Œ `Watch` çš„å…¶ä¸­ä¸€ä¸ª logo ç±»å‹æ”¹ä¸ºå…¶ä»–ç±»å‹ï¼Œ`Store` å°±æ— æ³•éµå¾ª `AppleStore` åè®®ã€‚

## å£°æ˜åè®®ç±»å‹çš„å˜é‡

### æ— å…³è”ç±»å‹åè®®çš„å˜é‡

å¦‚æœçœ‹è¿‡ [Kickstarter](https://github.com/kickstarter/ios-oss) çš„æºç ï¼Œä½ åº”è¯¥ä¼šç†Ÿæ‚‰å…¶ä¸­çš„ ViewModel çš„å†™æ³•ã€‚å®ƒçš„æ¨¡æ¿ç»“æ„å¦‚ä¸‹ï¼š

```swift
protocol AppDelegateViewModelInputs {
    func applicationDidBecomeActive()
    func applicationWillEnterForeground()
}

protocol AppDelegateViewModelOutputs {
    var pushTokenSuccessfullyGenerated: Signal<String, Never> { get }
}

protocol AppDelegateViewModelType {
    var inputs: AppDelegateViewModelInputs { get }
    var outputs: AppDelegateViewModelOutputs { get }
}

final class AppDelegateViewModel: AppDelegateViewModelType, AppDelegateViewModelInputs, AppDelegateViewModelOutputs {

    init() {}

    private let applicationDidBecomeActiveProperty = MutableProperty(())
    func applicationDidBecomeActive() {
        applicationDidBecomeActiveProperty.value = ()
    }

    private let applicationWillEnterForegroundProperty = MutableProperty(())
    func applicationWillEnterForeground() {
        applicationWillEnterForegroundProperty.value = ()
    }

    let pushTokenSuccessfullyGenerated: Signal<String, Never>

    var inputs: AppDelegateViewModelInputs { return self }
    var outputs: AppDelegateViewModelOutputs { return self }
}
```

è¿™é‡Œä»¥ `AppDelegate` çš„ ViewModel ä¸ºä¾‹ï¼Œ`AppDelegateViewModelType` åè®®è§„å®šäº† `inputs` å’Œ `outputs` ä¸¤ä¸ªå˜é‡ï¼Œå¹¶ä¸”ç±»å‹éƒ½æ˜¯åè®®ç±»å‹ï¼Œæ‰€ä»¥ä½¿ç”¨æ—¶å°±èƒ½ç›´æ¥è°ƒç”¨åè®®è§„å®šçš„æ–¹æ³•æˆ–è€…å˜é‡ï¼Œä¾‹å¦‚ï¼š

```swift
viewModel.inputs.applicationDidBecomeActive()
viewModel.outputs.pushTokenSuccessfullyGenerated
    .observeForUI()
    .observeValues { token in
        print("ğŸ“² [Push Registration] Push token successfully generated (\(token)) âœ¨")
    }
```

`inputs` å’Œ `outputs` ä¸¤ä¸ªåè®®ç±»å‹çš„å˜é‡å¸¦æ¥çš„å¥½å¤„æ˜¯åŒºåˆ† ViewModel æ•°æ®è¾“å…¥å’Œè¾“å‡ºï¼Œè®©ä»£ç çš„æ„å›¾æ›´æ¸…æ™°ã€‚

ç°åœ¨é—®é¢˜æ¥äº†ï¼šå¦‚æœ `inputs` å’Œ `outputs` çš„åè®®ç±»å‹å¸¦æœ‰å…³è”ç±»å‹ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ

### æœ‰å…³è”ç±»å‹åè®®çš„å˜é‡

è‡ªä»é˜…è¯»äº† [Kickstarter](https://github.com/kickstarter/ios-oss) çš„æºç ï¼Œæˆ‘å·²ç»åœ¨é¡¹ç›®ä¸Šç”¨ä¸Šäº†è¿™ç§ç»“æ„æ¨¡å¼ï¼Œå…¶ä¸­å°±é‡åˆ°äº†éœ€è¦æŠŠ `inputs` å’Œ `outputs` å®šä¹‰ä¸ºå¸¦æœ‰å…³è”ç±»å‹åè®®çš„å˜é‡çš„æƒ…å†µã€‚

æˆ‘çš„æƒ…å†µå¦‚ä¸‹ï¼šæœ‰å¾ˆå¤šä¸ªé¡µé¢éƒ½æ˜¯ä»æœåŠ¡å™¨åŠ è½½ä¸€ä¸ªæ•°ç»„ï¼Œç„¶åç”¨ `UITableView` æ˜¾ç¤ºå‡ºæ¥ï¼Œæ¯ä¸ªé¡µé¢éƒ½å¯¹åº”ä¸€ä¸ª ViewModelã€‚å†™ç€å†™ç€ä½ ä¼šå‘ç°ï¼Œè¿™äº› ViewModel éƒ½éå¸¸ç±»ä¼¼ï¼Œé™¤äº†æ•°ç»„å…ƒç´ çš„ç±»å‹ä¸ä¸€æ ·ï¼Œå…¶ä»–éƒ½ä¸€æ ·ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠè¿™äº› ViewModels æŠ½è±¡å‡ºä¸€ä¸ªæ³›å‹çš„ ViewModelï¼Œè¿™æ ·å°±å¯ä»¥ä¸€ä¸ª ViewModel ç”¨åœ¨æ‰€æœ‰æ˜¾ç¤ºæ•°ç»„çš„ç•Œé¢ä¸Šã€‚

æˆ‘é¦–å…ˆå°è¯•æŠŠ ViewModel çš„ä»£ç å¦‚ä¸‹ï¼š

```swift
protocol ListViewModelInputs {
    func viewDidLoad()
}

protocol ListViewModelOutputs {
    associatedtype ItemType
    // æŠ¥é”™ï¼šProtocol 'ListViewModelOutputs' can only be used as a generic constraint because it has Self or associated type requirements
    var itemsLoaded: Signal<[ItemType], Never> { get }
}

protocol ListViewModelType {
    var inputs: ListViewModelInputs { get }
    var outputs: ListViewModelOutputs { get }
}

class ListViewModel<ItemType: ListItemType>: ListViewModelInputs, ListViewModelOutputs, ListViewModelType {
    
    init(
        loadList: @escaping () -> SignalProducer<ModelsDataWrapper<ItemType>, ErrorEnvelope>
    ) {
        let loadItems = viewDidLoadProperty.signal
            .switchMap { _ in
                loadList().materialize()
        }
        
        itemsLoaded = loadItems.values().map { $0.models }
    }
    
    let viewDidLoadProperty = MutableProperty(())
    func viewDidLoad() {
        viewDidLoadProperty.value = ()
    }
    
    var itemsLoaded: Signal<[ItemType], Never>
    
    var inputs: ListViewModelInputs { return self }
    // æŠ¥é”™ 'ListViewModelOutputs' can only be used as a generic constraint because it has Self or associated type requirements
    var outputs: ListViewModelOutputs { return self }
}
```

å½“ä»£ç å†™å®Œåå‘ç°ï¼ŒæŠ¥é”™äº†ï¼Œé”™è¯¯çš„æ„æ€æ˜¯è¯´ `ListViewModelOutputs` åªèƒ½ç”¨ä½œæ³›å‹çº¦æŸï¼Œå› ä¸ºå®ƒå…·æœ‰ Self æˆ–å…³è”çš„ç±»å‹è¦æ±‚ã€‚

éš¾é“æ— æ³•å®šä¹‰æœ‰å…³è”ç±»å‹åè®®çš„å˜é‡äº†å—ï¼Ÿä¸ï¼Œè¿˜æ˜¯å¯ä»¥å®šä¹‰çš„ï¼Œåœ¨ iOS 13 ä»¥ä¸Šï¼Œå¯ä»¥æŠŠ `ListViewModelOutputs` æ”¹ä¸ºï¼š

```swift
protocol ListViewModelType {
    associatedtype OutputType: ListViewModelOutputs
    var inputs: ListViewModelInputs { get }
    var outputs: OutputType { get }
}

class ListViewModel<ItemType: ListItemType>: ListViewModelInputs, ListViewModelOutputs, ListViewModelType {
    var outputs: some ListViewModelOutputs { return self }
}
```

`ListViewModelType` çš„ `outputs` ä½¿ç”¨äº†å…³è”æŒ‰ç±»å‹ï¼Œ ListViewModel çš„ `outputs` ä½¿ç”¨äº† `some` å…³é”®å­—ï¼Œæ”¹æˆè¿™æ ·å°±ä¸ä¼šæŠ¥é”™äº†ã€‚

`some` æ˜¯ Swift 5.1 æ–°å¢çš„ç‰¹æ€§ï¼Œæƒ³è¦å…·ä½“äº†è§£ `some`ï¼Œå¯ä»¥æŸ¥çœ‹ä¹‹å‰å†™çš„æ–‡ç«  [Swift 5.1 æ–°ç‰¹æ€§
](https://www.jianshu.com/p/4c1545b9a7b7)ï¼Œæœç´¢ `æ¨¡ç³Šçš„ç»“æœç±»å‹ (Opaque Result Types)`ã€‚

è™½ç„¶æŠ¥é”™çš„é—®é¢˜è§£å†³äº†ï¼Œä½†æ˜¯ Kickstarter çš„è¿™ç§ ViewModel ç»“æ„æ¨¡å¼å°±æ— æ³•ä½¿ç”¨äº†ã€‚ä¾‹å¦‚æœ‰ä¸€ä¸ª ViewModelï¼š

```swift
let taxViewModel = ListViewModel<Tax>(loadList: AppEnvironment.current.apiService.loadTaxes)
```

é—®é¢˜åœ¨äº `taxViewModel.outputs.itemsLoaded` çš„ç±»å‹æ˜¯ `Signal<[(some TestListViewModelOutputs).ItemType], Never>`ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ `Signal<[Tax], Never>`ã€‚

æ‰€ä»¥æˆ‘æœ€åä¸å¾—ä¸æŠŠç›¸å…³çš„ protocol å»æ‰ï¼Œç›´æ¥å®šä¹‰ classï¼š

```swift
class ListViewModel<ItemType: ListItemType> {

    init(
        loadList: @escaping () -> SignalProducer<ModelsDataWrapper<ItemType>, ErrorEnvelope>
    ) {
        let loadItems = viewDidLoadProperty.signal
            .switchMap { _ in
                loadList().materialize()
        }

        itemsLoaded = loadItems.values().map { $0.models }
    }

    let viewDidLoadProperty = MutableProperty(())
    func viewDidLoad() {
        viewDidLoadProperty.value = ()
    }

    var itemsLoaded: Signal<[ItemType], Never>

    var inputs: ListViewModel { return self }
    var outputs: ListViewModel { return self }
}
```

è¿™é‡Œçš„ `inputs` å’Œ `outputs` ä¸»è¦æ˜¯è¦ä¸ºäº† ViewModel çš„é£æ ¼ä¿æŒä¸€è‡´ï¼Œå¹¶ä¸èƒ½ä¸¥æ ¼åŒºåˆ†è¾“å…¥å’Œè¾“å‡ºã€‚

### æ€è€ƒ

å¯¹äºä¸Šé¢ `taxViewModel` çš„ä¾‹å­ï¼š

```swift
let taxViewModel = ListViewModel<Tax>(loadList: AppEnvironment.current.apiService.loadTaxes)
```

`taxViewModel.outputs.itemsLoaded` çš„ç±»å‹æ˜¯ `Signal<[(some TestListViewModelOutputs).ItemType], Never>`ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ `Signal<[Tax], Never>`ã€‚

æˆ‘è®¤ä¸ºç¼–è¯‘å™¨åº”è¯¥æŠŠ `taxViewModel.outputs.itemsLoaded` æ¨æ–­æˆ `Signal<[Tax], Never>` ç±»å‹ã€‚å› ä¸º `ListViewModel<Tax>` å·²ç»æ˜ç¡® `ItemType` æ˜¯ `Tax` ç±»å‹ï¼Œä¹Ÿå°±æ„å‘³ç€ `ListViewModelOutputs` åè®®è§„å®šçš„ `var itemsLoaded: Signal<[ItemType], Never>` å…·ä½“ç±»å‹æ˜¯ `Signal<[Tax], Never>`ï¼Œæ‰€ä»¥  `taxViewModel.outputs.itemsLoaded` åº”è¯¥æ˜¯ `Signal<[Tax], Never>` ç±»å‹ã€‚